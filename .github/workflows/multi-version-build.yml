# å¤šç‰ˆæœ¬æ„å»ºå·¥ä½œæµ - ä¸“é—¨ç”¨äºæ„å»ºä¸åŒMinecraftç‰ˆæœ¬çš„mod
# å»ºè®®åœ¨ multi-version åˆ†æ”¯ä¸Šè¿è¡Œæ­¤å·¥ä½œæµ

name: Multi-Version Build
on:
  push:
    branches:
      - multi-version
      - 'release/**'
  pull_request:
    branches:
      - multi-version
  workflow_dispatch:
    inputs:
      versions_to_build:
        description: 'è¦æ„å»ºçš„ç‰ˆæœ¬ (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: 1.21.5,1.21.6,1.21.7,1.21.8 æˆ– all)'
        required: false
        default: 'all'
        type: string
      debug_enabled:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'åˆ›å»ºGitHub Release'
        required: false
        default: false
        type: boolean

jobs:
  prepare-matrix:
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Prepare build matrix
        id: set-matrix
        run: |
          # å®šä¹‰æ‰€æœ‰å¯ç”¨ç‰ˆæœ¬
          declare -A versions=(
            ["1.21.5"]="build_version/1.21/gradle-1.21.5.properties"
            ["1.21.6"]="build_version/1.21/gradle-1.21.6.properties"
            ["1.21.7"]="gradle.properties"
            ["1.21.8"]="build_version/1.21/gradle-1.21.8.properties"
          )
          
          # è§£æè¾“å…¥çš„ç‰ˆæœ¬
          if [ "${{ inputs.versions_to_build }}" == "all" ] || [ -z "${{ inputs.versions_to_build }}" ]; then
            # æ„å»ºæ‰€æœ‰ç‰ˆæœ¬
            build_versions="1.21.5,1.21.6,1.21.7,1.21.8"
          else
            build_versions="${{ inputs.versions_to_build }}"
          fi
          
          # æ„å»ºmatrix JSON
          matrix_json="["
          IFS=',' read -ra VERSION_ARRAY <<< "$build_versions"
          for i in "${!VERSION_ARRAY[@]}"; do
            version="${VERSION_ARRAY[$i]// /}"  # å»é™¤ç©ºæ ¼
            if [[ -n "${versions[$version]}" ]]; then
              if [ $i -gt 0 ]; then
                matrix_json+=","
              fi
              matrix_json+="{\"version\":\"$version\",\"properties_file\":\"${versions[$version]}\"}"
            fi
          done
          matrix_json+="]"
          
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "æ„å»ºçŸ©é˜µ: $matrix_json"

  build:
    needs: prepare-matrix
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'

      - name: Make gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Setup version-specific properties
        run: |
          echo "æ­£åœ¨ä¸º Minecraft ${{ matrix.version }} è®¾ç½®æ„å»ºå±æ€§..."
          if [ "${{ matrix.properties_file }}" != "gradle.properties" ]; then
            cp "${{ matrix.properties_file }}" gradle.properties
            echo "å·²å¤åˆ¶ ${{ matrix.properties_file }} åˆ° gradle.properties"
          else
            echo "ä½¿ç”¨é»˜è®¤çš„ gradle.properties (Minecraft ${{ matrix.version }})"
          fi
          
          # æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬ä¿¡æ¯
          echo "å½“å‰æ„å»ºé…ç½®:"
          grep -E "(minecraft_version|mod_version|fabric_version)" gradle.properties

      - name: Setup gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/multi-version' }}

      - name: Run tests for ${{ matrix.version }}
        run: |
          echo "ğŸ§ª è¿è¡Œ Minecraft ${{ matrix.version }} çš„æµ‹è¯•..."
          if [ "${{ inputs.debug_enabled }}" == "true" ]; then
            ./gradlew test --continue --info --stacktrace
          else
            ./gradlew test --continue
          fi

      - name: Build mod for ${{ matrix.version }}
        run: |
          echo "ğŸ”¨ æ„å»º Minecraft ${{ matrix.version }} ç‰ˆæœ¬çš„mod..."
          if [ "${{ inputs.debug_enabled }}" == "true" ]; then
            ./gradlew build --info --stacktrace
          else
            ./gradlew build
          fi

      - name: Upload test reports for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.version }}
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 30

      - name: Upload mod artifacts for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: mod-${{ matrix.version }}
          path: |
            build/libs/*.jar
            !build/libs/*-sources.jar
          retention-days: 90

      - name: Upload sources for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: sources-${{ matrix.version }}
          path: build/libs/*-sources.jar
          retention-days: 90

  create-release:
    if: ${{ inputs.create_release == true && github.event_name == 'workflow_dispatch' }}
    needs: [prepare-matrix, build]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # ç»„ç»‡æ‰€æœ‰æ„å»ºçš„modæ–‡ä»¶
          for version_dir in artifacts/mod-*/; do
            if [ -d "$version_dir" ]; then
              version=$(basename "$version_dir" | sed 's/mod-//')
              echo "å¤„ç†ç‰ˆæœ¬: $version"
              cp "$version_dir"/*.jar "release-assets/" 2>/dev/null || true
            fi
          done
          
          # ç»„ç»‡æºç æ–‡ä»¶
          for sources_dir in artifacts/sources-*/; do
            if [ -d "$sources_dir" ]; then
              cp "$sources_dir"/*.jar "release-assets/" 2>/dev/null || true
            fi
          done
          
          ls -la release-assets/
      
      - name: Get mod version
        id: mod_version
        run: |
          version=$(grep "mod_version=" gradle.properties | cut -d'=' -f2)
          echo "version=$version" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.mod_version.outputs.version }}-multi
          name: "Luminous LLM Chat v${{ steps.mod_version.outputs.version }} (å¤šç‰ˆæœ¬)"
          body: |
            ## ğŸ® å¤šç‰ˆæœ¬å‘å¸ƒ
            
            æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹Minecraftç‰ˆæœ¬çš„æ„å»ºï¼š
            
            ${{ needs.prepare-matrix.outputs.matrix }}
            
            ### ğŸ“¦ åŒ…å«çš„æ–‡ä»¶
            - å„ç‰ˆæœ¬çš„mod jaræ–‡ä»¶
            - å¯¹åº”çš„æºç æ–‡ä»¶
            
            ### ğŸ”§ å®‰è£…è¯´æ˜
            1. é€‰æ‹©å¯¹åº”æ‚¨Minecraftç‰ˆæœ¬çš„jaræ–‡ä»¶
            2. å°†æ–‡ä»¶æ”¾å…¥modsæ–‡ä»¶å¤¹
            3. ç¡®ä¿å·²å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„Fabric Loaderå’ŒFabric API
            
            ### ğŸ“‹ ç‰ˆæœ¬å…¼å®¹æ€§
            - Minecraft 1.21.5+
            - Fabric Loader 0.16.14+
            - Java 21+
          files: release-assets/*
          draft: false
          prerelease: false
